# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build puppeteer`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t puppeteer`.
FROM oven/bun:1.3.5-slim

ENV NODE_ENV=production
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
ENV DBUS_SESSION_BUS_ADDRESS=autolaunch:
ENV LANG=en_US.UTF-8

LABEL org.opencontainers.image.authors="philiplehmann@gmail.com"

RUN --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    --mount=type=cache,target=/var/cache/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    apt-get update && \
    apt-get upgrade --yes && \
    apt-get install --no-install-recommends --yes \
                    libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libgbm1 libasound2 \
                    libpangocairo-1.0-0 libxss1 libgtk-3-0 libgtk2.0-0 libdrm2 libxkbcommon0 \
                    wget gnupg \
                    dbus dbus-x11 \
                    fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-freefont-ttf \
                    chromium && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

RUN usermod -a -G audio,video bun && \
    mkdir /app/chromium-data && \
    chown -R 1000:1000 /app/chromium-data

ENV HOST=0.0.0.0
ENV PORT=3000

COPY --chown=1000:1000 dist/apps/puppeteer puppeteer

# You can remove this install step if you build with `--bundle` option.
# The bundled output will include external dependencies.
RUN bun install --production --cwd puppeteer

USER 1000:1000

CMD [ "bun", "puppeteer" ]
