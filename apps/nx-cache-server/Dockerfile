# This file is generated by Nx.
#
# Build the docker image with `bun nx docker-build nx-cache-server`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t philiplehmann/nx-cache-server`.
FROM rust:1.92.0-trixie AS rust

ARG NX_CACHE_SERVER_VERSION

ADD https://github.com/nxcite/nx-cache-server/archive/refs/tags/v${NX_CACHE_SERVER_VERSION}.tar.gz v${NX_CACHE_SERVER_VERSION}.tar.gz

RUN tar -xzf v${NX_CACHE_SERVER_VERSION}.tar.gz; \
    cd nx-cache-server-${NX_CACHE_SERVER_VERSION}; \
    cargo install --path .

FROM debian:trixie-slim

ENV PORT=3000

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*
RUN useradd -ms /bin/bash -u 1000 nx-cache-server

# # Required
# export S3_BUCKET_NAME="your-s3-bucket-name"
# export SERVICE_ACCESS_TOKEN="your-bearer-token"
#
# # AWS Credentials (optional - auto-discovered from IAM roles, config files, SSO if not provided)
# export AWS_ACCESS_KEY_ID="your-aws-access-key-id"
# export AWS_SECRET_ACCESS_KEY="your-aws-secret-access-key"
# export AWS_SESSION_TOKEN="your-session-token"  # If you are using temporary credentials
#
# # AWS Region (optional - auto-discovered from AWS config, EC2/ECS metadata if not provided)
# export AWS_REGION="us-west-2"
#
# # Optional
# export S3_ENDPOINT_URL="your-s3-endpoint-url"   # For S3-compatible services like MinIO
# export S3_TIMEOUT="30"                          # S3 operation timeout in seconds (default: 30)
# export PORT="3000"                              # Server port (default: 3000)

COPY --from=rust /usr/local/cargo/bin/nx-cache-aws /usr/local/bin/nx-cache-aws

USER nx-cache-server
EXPOSE $PORT

CMD [ "/usr/local/bin/nx-cache-aws" ]
