# This file is generated by Nx.
#
# Build the docker image with `bun nx docker-build nx-cache-server`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t philiplehmann/nx-cache-server`.

# Builder stage to download the binary
FROM --platform=$BUILDPLATFORM debian:trixie-slim AS builder

ARG NX_CACHE_SERVER_VERSION
ARG TARGETPLATFORM

RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Download architecture-specific binary based on target platform
RUN ARCH_SUFFIX=$(case ${TARGETPLATFORM} in \
    linux/amd64) echo "x86_64" ;; \
    linux/arm64) echo "arm64" ;; \
    *) echo "Unsupported platform: ${TARGETPLATFORM}" && exit 1 ;; \
    esac) && \
    curl -L "https://github.com/philiplehmann/nx-cache-server/releases/download/v${NX_CACHE_SERVER_VERSION}/nx-cache-server-v${NX_CACHE_SERVER_VERSION}-linux-${ARCH_SUFFIX}" \
    -o /tmp/nx-cache-server && \
    chmod +x /tmp/nx-cache-server

# Final stage - minimal runtime image
FROM --platform=$TARGETPLATFORM debian:trixie-slim

ENV PORT=3000

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -ms /bin/bash -u 1000 nx-cache-server

# Copy binary from builder stage
COPY --from=builder /tmp/nx-cache-server /usr/local/bin/nx-cache-server

# # Required
# export S3_BUCKET_NAME="your-s3-bucket-name"
# export SERVICE_ACCESS_TOKEN="your-bearer-token"
#
# # AWS Credentials (optional - auto-discovered from IAM roles, config files, SSO if not provided)
# export AWS_ACCESS_KEY_ID="your-aws-access-key-id"
# export AWS_SECRET_ACCESS_KEY="your-aws-secret-access-key"
# export AWS_SESSION_TOKEN="your-session-token"  # If you are using temporary credentials
#
# # AWS Region (optional - auto-discovered from AWS config, EC2/ECS metadata if not provided)
# export AWS_REGION="us-west-2"
#
# # Optional
# export S3_ENDPOINT_URL="your-s3-endpoint-url"   # For S3-compatible services like MinIO
# export S3_TIMEOUT="30"                          # S3 operation timeout in seconds (default: 30)
# export PORT="3000"                              # Server port (default: 3000)

USER nx-cache-server
EXPOSE $PORT

CMD [ "/usr/local/bin/nx-cache-server" ]
