# This file is generated by Nx.
#
# Build the docker image with `bun nx docker-build unoserver`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t philiplehmann/unoserver`.
FROM oven/bun:1.3.4-slim

ARG UNOSERVER_VERSION
ARG JRE_VERSION

WORKDIR /app

# setup adoptium repository
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    ca-certificates
RUN curl -fsSL https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor -o /usr/share/keyrings/adoptium-archive-keyring.gpg
RUN echo "deb [signed-by=/usr/share/keyrings/adoptium-archive-keyring.gpg] https://packages.adoptium.net/artifactory/deb trixie main" > /etc/apt/sources.list.d/adoptium.list

RUN --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    --mount=type=cache,target=/var/cache/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    apt-get update && \
    apt-get install --yes --no-install-recommends \
                    python3-full python3-pip python3-uno uno-libs-private virtualenv \
                    libreoffice-java-common \
                    libreoffice-writer \
                    libreoffice-calc \
                    libreoffice-impress \
                    libreoffice-draw \
                    temurin-21-jdk \
                    fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-freefont-ttf fonts-dejavu \
                    fonts-liberation fonts-noto-core fonts-noto-extra fonts-crosextra-carlito fonts-crosextra-caladea fonts-liberation2 && \
    virtualenv --python=/usr/bin/python3 --system-site-packages virtenv && \
    virtenv/bin/pip install unoserver==${UNOSERVER_VERSION}

RUN mkdir /app/tmp && \
    chown -R 1000:1000 /app/tmp

ENV PATH="/app/virtenv/bin:${PATH}"
ENV HOST=0.0.0.0
ENV PORT=3000
ENV UNOSERVER_DIRECT_ONLY=false
ENV LIBREOFFICE_EXECUTABLE_PATH=/usr/bin/soffice

COPY dist/apps/unoserver unoserver

# You can remove this install step if you build with `--bundle` option.
# The bundled output will include external dependencies.
RUN bun install --production --cwd unoserver


USER 1000:1000

CMD [ "bun", "unoserver" ]
