# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build easyocr`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t philiplehmann/easyocr`.
FROM bitnami/minideb:bookworm AS models
RUN apt-get update && \
    apt-get install --no-install-recommends --yes unzip

WORKDIR /app

RUN mkdir /app/model

ADD https://github.com/JaidedAI/EasyOCR/releases/download/pre-v1.1.6/craft_mlt_25k.zip /app/model/craft_mlt_25k.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/english_g2.zip /app/model/english_g2.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/latin_g2.zip /app/model/latin_g2.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/zh_sim_g2.zip /app/model/zh_sim_g2.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/japanese_g2.zip /app/model/japanese_g2.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/korean_g2.zip /app/model/korean_g2.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.2/telugu.zip /app/model/telugu.zip
ADD https://github.com/JaidedAI/EasyOCR/releases/download/v1.2/kannada.zip /app/model/kannada.zip

RUN unzip /app/model/craft_mlt_25k.zip -d /app/model && \
    unzip /app/model/english_g2.zip -d /app/model && \
    unzip /app/model/latin_g2.zip -d /app/model && \
    unzip /app/model/zh_sim_g2.zip -d /app/model && \
    unzip /app/model/japanese_g2.zip -d /app/model && \
    unzip /app/model/korean_g2.zip -d /app/model && \
    unzip /app/model/telugu.zip -d /app/model && \
    unzip /app/model/kannada.zip -d /app/model && \
    rm /app/model/craft_mlt_25k.zip && \
    rm /app/model/english_g2.zip && \
    rm /app/model/latin_g2.zip && \
    rm /app/model/zh_sim_g2.zip && \
    rm /app/model/japanese_g2.zip && \
    rm /app/model/korean_g2.zip && \
    rm /app/model/telugu.zip && \
    rm /app/model/kannada.zip

FROM bitnami/pytorch:2.6.0 AS easyocr

USER 0:0

WORKDIR /app

COPY apps/easyocr/requirements.txt .
COPY apps/easyocr/src/main.py main.py

RUN pip install --no-cache-dir -r requirements.txt

COPY --from=models --chown=1000:1000 /app/model /app/model

RUN mkdir /app/tmp && \
    chown -R 1000:1000 /app/tmp

ENV PORT=3000
ENV WEB_CONCURRENCY=1

USER 1000:1000

CMD ["gunicorn", "main:easyocr"]
