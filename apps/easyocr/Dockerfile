# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build easyocr`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t philiplehmann/easyocr`.
FROM python:3.14-trixie

WORKDIR /app

RUN --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    --mount=type=cache,target=/var/cache/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    apt update && \
    apt install -y libvips libvips-dev && \
    rm -rf /var/lib/apt/lists/* && \
    pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cu130 && \
    mkdir -p /app/model && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/pre-v1.1.6/craft_mlt_25k.zip --output /app/model/craft_mlt_25k.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/english_g2.zip --output /app/model/english_g2.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/latin_g2.zip --output /app/model/latin_g2.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/zh_sim_g2.zip --output /app/model/zh_sim_g2.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/japanese_g2.zip --output /app/model/japanese_g2.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.3/korean_g2.zip --output /app/model/korean_g2.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.2/telugu.zip --output /app/model/telugu.zip && \
    curl -L https://github.com/JaidedAI/EasyOCR/releases/download/v1.2/kannada.zip --output /app/model/kannada.zip && \
    unzip /app/model/craft_mlt_25k.zip -d /app/model && \
    unzip /app/model/english_g2.zip -d /app/model && \
    unzip /app/model/latin_g2.zip -d /app/model && \
    unzip /app/model/zh_sim_g2.zip -d /app/model && \
    unzip /app/model/japanese_g2.zip -d /app/model && \
    unzip /app/model/korean_g2.zip -d /app/model && \
    unzip /app/model/telugu.zip -d /app/model && \
    unzip /app/model/kannada.zip -d /app/model && \
    rm /app/model/craft_mlt_25k.zip && \
    rm /app/model/english_g2.zip && \
    rm /app/model/latin_g2.zip && \
    rm /app/model/zh_sim_g2.zip && \
    rm /app/model/japanese_g2.zip && \
    rm /app/model/korean_g2.zip && \
    rm /app/model/telugu.zip && \
    rm /app/model/kannada.zip

COPY apps/easyocr/requirements.txt .
COPY apps/easyocr/src/main.py .
COPY apps/easyocr/src/logging.conf .

RUN pip install --no-cache-dir -r requirements.txt

RUN mkdir /app/tmp && \
    chown -R 1000:1000 /app

ENV PORT=3000
ENV WEB_CONCURRENCY=1

USER 1000:1000

CMD ["uvicorn", "main:app", "--log-config=logging.conf"]
